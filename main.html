<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8" />
<title>Koning Dodo</title>
<style>
  body, html {
    height: 100%;
    margin: 0;
    padding: 0;
  }
  body {
    font-family: Arial, sans-serif;
    color: #fff;
    background: url('https://i.imgur.com/y9tD43R.jpeg') no-repeat center center fixed;
    background-size: cover;
    position: relative;
  }
  body::before {
    content: "";
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    pointer-events: none;
    z-index: -1;
  }
  header {
    background-color: #006400cc;
    padding: 15px;
    text-align: center;
    border-bottom: 5px solid #ff8c00;
    position: sticky;
    top: 0;
    z-index: 20;
  }
  header img {
    height: 80px;
  }
  main {
    max-width: 1100px;
    margin: 20px auto 40px;
    display: flex;
    gap: 20px;
    padding: 0 20px;
    min-height: 80vh;
    position: relative;
  }
  .betslip {
    background-color: #004d00dd;
    padding: 15px;
    border-radius: 10px;
    width: 350px;
    color: #fff;
    box-shadow: 0 0 6px 2px rgba(255, 140, 0, 0.5);
    position: sticky;
    top: 20px;
    align-self: flex-start;
  }
  .betslip h2 {
    color: #ff8c00;
  }
  .betslip input, .betslip button {
    width: 90%;
    max-width: 300px;
    padding: 10px;
    margin-top: 10px;
    border-radius: 5px;
    border: none;
    font-size: 16px;
  }
  .betslip button {
    background-color: #ff8c00;
    color: #fff;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
  }
  .betslip button:hover:enabled {
    background-color: #e07b00;
    transform: scale(1.05);
    box-shadow: 0 0 12px #ff8c00dd;
  }
  .betslip button:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }
  .matches {
    flex: 1;
    max-width: 700px;
    overflow-wrap: break-word;
  }
  .league {
    background-color: #006400dd;
    padding: 10px;
    border-radius: 10px;
    margin-bottom: 20px;
    box-shadow: 0 0 6px 2px rgba(255, 140, 0, 0.5);
  }
  .league-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    cursor: pointer;
    user-select: none;
  }
  .league-header h2 {
    margin: 0;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  .league-header img.league-icon {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    box-shadow: 0 0 0 2px rgba(255, 140, 0, 0.35);
  }
  .toggle-icon {
    font-size: 20px;
    transition: transform 0.3s ease;
  }
  .toggle-icon.open {
    transform: rotate(90deg);
  }
  .match-list {
    margin-top: 10px;
    display: none;
  }
  .match {
    background-color: #004d00cc;
    padding: 10px;
    border-radius: 5px;
    margin: 5px 0;
    transition: background-color 0.3s ease, box-shadow 0.3s ease;
    cursor: pointer;
    animation: fadeIn 0.5s ease forwards;
  }
  .match:hover {
    background-color: rgba(0, 100, 0, 0.95);
    box-shadow: 0 0 10px #007700cc;
  }
  .market-title {
    margin: 8px 0 4px;
    font-size: 14px;
    color: #ffcc00;
  }
  .odds {
    display: flex;
    flex-wrap: wrap;
  }
  .odds button {
    background-color: #ff8c00;
    border: none;
    padding: 5px 10px;
    color: #fff;
    margin: 0 5px 5px 0;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
  }
  .odds button:hover {
    background-color: #e07b00;
    transform: scale(1.05);
    box-shadow: 0 0 12px #ff8c00dd;
  }
  .match p {
    margin: 5px 0;
  }
  #stakeWarning, #payoutWarning {
    color: red;
    font-weight: bold;
    display: none;
  }
  .bet-info {
    margin-top: 15px;
    font-size: 14px;
    color: #ffcc00;
    text-align: center;
  }
  @keyframes fadeIn {
    from {opacity: 0; transform: translateY(10px);}
    to {opacity: 1; transform: translateY(0);}
  }
</style>
</head>
<body>

<header>
  <img src="https://i.imgur.com/YpEK9A2.png" alt="Koning Dodo logo" />
</header>

<main>
  <div class="betslip" id="betslip">
    <h2>Jouw Betslip</h2>
    <input type="text" id="bettorName" placeholder="Discord naam (@...)" required />
    <div id="bets"></div>
    <p><strong>Totaal Odds:</strong> <span id="totalOdds">1.00</span></p>
    <p><strong>Potentiële Uitbetaling:</strong> €<span id="potentialPayout">0,00</span></p>
    <p id="payoutWarning"></p>
    <input type="number" id="stake" placeholder="Inzet (€)" min="75000" />
    <p id="stakeWarning"></p>
    <button id="sendBtn" onclick="sendToDiscord()">Verstuur naar Discord</button>
    <p class="bet-info">Minimale inzet 75K • Maximale inzet 350K • Maximale uitbetaling 2.0M</p>
  </div>

  <div class="matches" id="matches"></div>
</main>

<script>
const apiKey = "9b7a7c15dd348a78c4feee37ded6e1d0";
const webhookURL = "https://discord.com/api/webhooks/1404901242307608706/KpY04R63ezeTL6WQCFvtLd1HwlA9_JeR0GhtfpVniqMgsOV6lhLtQMuV3-bHeM1LfxwU";

/** ---------- League icons (SVG badges, geen emoji's) ---------- **/
function svgBadge(text, bg="#0b3d91") {
  const svg = `
  <svg xmlns='http://www.w3.org/2000/svg' width='64' height='64' viewBox='0 0 64 64'>
    <defs>
      <linearGradient id='g' x1='0' y1='0' x2='0' y2='1'>
        <stop offset='0%' stop-color='${bg}' stop-opacity='1'/>
        <stop offset='100%' stop-color='#062b62' stop-opacity='1'/>
      </linearGradient>
    </defs>
    <circle cx='32' cy='32' r='30' fill='url(#g)' stroke='#ff8c00' stroke-width='3'/>
    <text x='32' y='38' font-family='Arial, Helvetica, sans-serif' font-size='22' fill='#ffffff' text-anchor='middle' font-weight='bold'>${text}</text>
  </svg>`;
  return "data:image/svg+xml;utf8," + encodeURIComponent(svg);
}
function leagueIconSrc(name) {
  switch(name) {
    case "Eredivisie": return svgBadge("NL", "#006400");
    case "Champions League": return svgBadge("UCL", "#0b3d91"); // bevat ook kwalificatie
    case "Jupiler Pro League": return svgBadge("BE", "#c8102e");
    case "MMA / UFC": return svgBadge("UFC", "#d20a0a");
    default: return svgBadge("KD", "#444");
  }
}

/* --------- Leagues (Premier League verwijderd, UCL samengevoegd) --------- */
/* Je kunt nu óf een string key opgeven, óf een array met meerdere keys. */
const leagues = {
  "Eredivisie": "soccer_netherlands_eredivisie",
  "Champions League": ["soccer_uefa_champs_league_qualification", "soccer_uefa_champs_league"], // samengevoegd
  "Jupiler Pro League": "soccer_belgium_first_div",
  "MMA / UFC": "mma_mixed_martial_arts"
};

let betslip = [];
let loadedLeagues = {};
const MAX_INZET = 350000;   // €350K
const MIN_INZET = 75000;    // €75K
const MAX_PAYOUT = 2000000; // €2.0M
const ODDS_ADJUSTMENT = 0.900; // 10% verlaagd
const MIN_ODDS = 1.09; // minimale odds

function formatDateTimeToNL(utcDate) {
  const date = new Date(utcDate);
  return date.toLocaleString('nl-NL', {
    timeZone: 'Europe/Amsterdam',
    day: '2-digit', month: '2-digit', year: 'numeric',
    hour: '2-digit', minute: '2-digit'
  });
}

function formatCurrency(amount) {
  return amount.toLocaleString('nl-NL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function getMatchMinute(startTime) {
  const start = new Date(startTime);
  const now = new Date();
  const diffMinutes = Math.floor((now - start) / 60000);
  if (diffMinutes >= 0 && diffMinutes <= 120) {
    return `${diffMinutes}'`;
  }
  return null;
}

// Helper: check of match binnen 7 dagen is
function isWithinNext7Days(dateString) {
  const matchDate = new Date(dateString);
  const now = new Date();
  const sevenDaysLater = new Date();
  sevenDaysLater.setDate(now.getDate() + 7);
  return matchDate >= now && matchDate <= sevenDaysLater;
}

function createLeagueElement(name, key) {
  const iconSrc = leagueIconSrc(name);
  // Unieke ID (ook wanneer key een array is)
  const listId = "list-" + (Array.isArray(key) ? key.join("_") : key).replace(/[^a-zA-Z0-9_]/g, "_");

  const leagueDiv = document.createElement("div");
  leagueDiv.className = "league";
  leagueDiv.innerHTML = `
    <div class="league-header" tabindex="0">
      <h2><img class="league-icon" alt="${name} icon" src="${iconSrc}"/> ${name}</h2>
      <span class="toggle-icon">&#9654;</span>
    </div>
    <div class="match-list" id="${listId}"></div>
  `;
  const header = leagueDiv.querySelector(".league-header");
  const toggleIcon = leagueDiv.querySelector(".toggle-icon");
  const matchList = leagueDiv.querySelector(".match-list");

  header.addEventListener("click", () => toggleLeague(key, toggleIcon, matchList));
  return leagueDiv;
}

async function toggleLeague(key, toggleIcon, matchList) {
  const expanded = toggleIcon.classList.toggle("open");
  matchList.style.display = expanded ? "block" : "none";
  const keyId = Array.isArray(key) ? key.join("_") : key;
  if (expanded && !loadedLeagues[keyId]) {
    matchList.innerHTML = `<p>Laden...</p>`;
    try {
      const matches = await fetchMatches(key);
      const isMMA = (Array.isArray(key) ? key : [key]).some(k => String(k).startsWith("mma_"));
      renderMatches(matches, matchList, isMMA);
      loadedLeagues[keyId] = true;
    } catch (e) {
      console.error(e);
      matchList.innerHTML = `<p>Fout bij laden wedstrijden.</p>`;
    }
  }
}

/**
 * Fetch logic
 * - Ondersteunt een enkele key (string) of meerdere keys (array) en voegt resultaten samen.
 * - We gebruiken overal alleen H2H (Winnaar) voor stabiliteit (voorkomt 422 bij MMA).
 */
async function fetchMatches(leagueKeyOrKeys) {
  const keys = Array.isArray(leagueKeyOrKeys) ? leagueKeyOrKeys : [leagueKeyOrKeys];
  const requests = keys.map(key => {
    const url = `https://api.the-odds-api.com/v4/sports/${key}/odds/?apiKey=${apiKey}&regions=eu&markets=h2h&oddsFormat=decimal`;
    return fetch(url).then(res => {
      if (!res.ok) throw new Error(`API error ${res.status} for ${key}`);
      return res.json();
    });
  });

  const resultsArrays = await Promise.all(requests);
  // Flatten + eenvoudige dedup op id
  const combined = [].concat(...resultsArrays);
  const seen = new Set();
  const deduped = combined.filter(m => {
    if (seen.has(m.id)) return false;
    seen.add(m.id);
    return true;
  });

  // Sorteer op starttijd
  deduped.sort((a, b) => new Date(a.commence_time) - new Date(b.commence_time));
  return deduped;
}

function renderMatches(matches, container, isMMA) {
  container.innerHTML = "";

  // Filter op max 7 dagen vooruit
  const upcomingMatches = (matches || []).filter(m => isWithinNext7Days(m.commence_time));

  if (!upcomingMatches.length) {
    container.innerHTML = "<p>Geen wedstrijden/gevechten in de komende 7 dagen.</p>";
    return;
  }

  upcomingMatches.forEach(match => {
    const bookmaker = match.bookmakers?.[0];
    const market = bookmaker?.markets?.find(m => m.key === "h2h") || bookmaker?.markets?.[0];
    const outcomes = market?.outcomes || [];
    if (!outcomes.length) return;

    const home = match.home_team || (isMMA ? (outcomes?.[0]?.name || "Deelnemer A") : "Thuis");
    const away = match.away_team || (isMMA ? (outcomes?.[1]?.name || "Deelnemer B") : "Uit");

    const startTimeNL = formatDateTimeToNL(match.commence_time);
    const minute = getMatchMinute(match.commence_time);
    const minuteText = minute ? ` <strong>${minute}</strong>` : "";

    const matchDiv = document.createElement("div");
    matchDiv.className = "match";
    matchDiv.innerHTML = `
      <p><strong>${home} - ${away}</strong></p>
      <p><em>${startTimeNL}${minuteText}</em></p>
      <div class="market-title">${isMMA ? "Winnaar (MMA)" : "Winnaar"}</div>
      <div class="odds"></div>
    `;

    const sortedOutcomes = isMMA || !match.home_team
      ? [...outcomes]
      : [...outcomes].sort((a, b) => {
          if (a.name === match.home_team) return -1;
          if (b.name === match.home_team) return 1;
          return 0;
        });

    const oddsDiv = matchDiv.querySelector(".odds");
    sortedOutcomes.forEach(outcome => {
      const adjustedOdds = Math.max(MIN_ODDS, (outcome.price || 1) * ODDS_ADJUSTMENT);
      const btn = document.createElement("button");
      btn.textContent = `${outcome.name} (${adjustedOdds.toFixed(2)})`;
      btn.addEventListener("click", () => addBet(match, { ...outcome, price: adjustedOdds, marketKey: "h2h" }));
      oddsDiv.appendChild(btn);
    });

    container.appendChild(matchDiv);
  });
}

function addBet(match, outcome) {
  const betId = `${match.id}_h2h_${outcome.name}`;
  if (betslip.some(b => b.id === betId)) {
    alert("Deze selectie staat al in je betslip.");
    return;
  }
  betslip.push({ id: betId, match, outcome, odds: outcome.price });
  updateBetslip();
}

function updateBetslip() {
  const betsDiv = document.getElementById("bets");
  betsDiv.innerHTML = "";
  let totalOdds = 1;
  betslip.forEach(bet => {
    totalOdds *= bet.odds;
    const home = bet.match.home_team || "Deelnemer A";
    const away = bet.match.away_team || "Deelnemer B";
    const p = document.createElement("p");
    p.textContent = `${home} - ${away} • Winnaar: ${bet.outcome.name} (${bet.odds.toFixed(2)})`;

    const removeBtn = document.createElement("button");
    removeBtn.textContent = "Verwijder";
    removeBtn.style.marginLeft = "10px";
    removeBtn.style.backgroundColor = "#900";
    removeBtn.style.color = "#fff";
    removeBtn.style.padding = "2px 6px";
    removeBtn.style.borderRadius = "4px";
    removeBtn.style.fontSize = "12px";
    removeBtn.style.cursor = "pointer";
    removeBtn.addEventListener("click", () => {
      betslip = betslip.filter(b => b.id !== bet.id);
      updateBetslip();
    });
    p.appendChild(removeBtn);
    betsDiv.appendChild(p);
  });

  document.getElementById("totalOdds").textContent = totalOdds.toFixed(2);
  const inzet = parseFloat(document.getElementById("stake").value);
  const potential = inzet && inzet > 0 ? inzet * totalOdds : 0;

  const stakeInput = document.getElementById("stake");
  const stakeWarning = document.getElementById("stakeWarning");
  const payoutElem = document.getElementById("potentialPayout");
  const payoutWarning = document.getElementById("payoutWarning");
  const sendBtn = document.getElementById("sendBtn");

  stakeWarning.style.display = "none";
  payoutWarning.style.display = "none";
  stakeInput.style.border = "";
  payoutElem.style.color = "";

  let valid = true;

  if (!inzet || inzet < MIN_INZET) {
    stakeInput.style.border = "2px solid red";
    stakeWarning.textContent = `Minimale inzet is €${formatCurrency(MIN_INZET)}.`;
    stakeWarning.style.display = "block";
    valid = false;
  }

  if (inzet > MAX_INZET) {
    stakeInput.style.border = "2px solid red";
    stakeWarning.textContent = `Maximale inzet is €${formatCurrency(MAX_INZET)}.`;
    stakeWarning.style.display = "block";
    valid = false;
  }

  if (potential > MAX_PAYOUT && inzet > 0) {
    payoutElem.style.color = "red";
    payoutWarning.textContent = `Maximale uitbetaling is €${formatCurrency(MAX_PAYOUT)}. Je potentiële uitbetaling is €${formatCurrency(potential)}.`;
    payoutWarning.style.display = "block";
  } else {
    payoutElem.style.color = "";
    payoutWarning.style.display = "none";
  }

  document.getElementById("potentialPayout").textContent = formatCurrency(potential);
  sendBtn.disabled = !valid;
}

document.getElementById("stake").addEventListener("input", updateBetslip);

function sendToDiscord() {
  const bettorName = document.getElementById("bettorName").value.trim();
  if (!bettorName) { alert("Vul alsjeblieft je Discord naam in."); return; }
  if (!bettorName.startsWith("@")) { alert("Je Discord naam moet beginnen met '@'."); return; }
  if (betslip.length === 0) { alert("Je hebt nog geen weddenschappen toegevoegd."); return; }

  const inzet = parseFloat(document.getElementById("stake").value);
  if (!inzet || inzet <= 0) { alert("Vul een geldige inzet in."); return; }
  if (inzet < MIN_INZET || inzet > MAX_INZET) { alert(`Inzet moet tussen €${formatCurrency(MIN_INZET)} en €${formatCurrency(MAX_INZET)} liggen.`); return; }

  const totalOdds = parseFloat(document.getElementById("totalOdds").textContent);
  const potential = inzet * totalOdds;

  let payoutText = `€${formatCurrency(potential)}`;
  if (potential > MAX_PAYOUT) {
      payoutText += ` (Max uitbetaling €${formatCurrency(MAX_PAYOUT)})`;
  }

  let description = `**Wedder:** ${bettorName}\n**Inzet:** €${formatCurrency(inzet)}\n**Totaal Odds:** ${totalOdds.toFixed(2)}\n**Potentiële Uitbetaling:** ${payoutText}\n\n**Weddenschappen:**\n`;
  betslip.forEach(bet => {
    const matchDate = formatDateTimeToNL(bet.match.commence_time);
    const home = bet.match.home_team || "Deelnemer A";
    const away = bet.match.away_team || "Deelnemer B";
    description += `- ${home} - ${away} (${matchDate}) • Winnaar: ${bet.outcome.name} (${bet.odds.toFixed(2)})\n`;
  });

  const payload = {
    username: "Koning Dodo",
    embeds: [{ title: "Nieuwe weddenschap", description, color: 5763719, footer: { text: "Koning Dodo" }, timestamp: new Date().toISOString() }]
  };

  fetch(webhookURL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  }).then(res => {
    if (res.ok) {
      alert("Weddenschap verstuurd naar Discord!");
      betslip = [];
      updateBetslip();
      document.getElementById("bettorName").value = "";
      document.getElementById("stake").value = "";
    } else {
      alert("Er is een fout opgetreden bij het versturen.");
    }
  }).catch(() => alert("Er is een fout opgetreden bij het versturen."));
}

(async function loadAllLeagues() {
  const matchesContainer = document.getElementById("matches");
  for (const [name, key] of Object.entries(leagues)) {
    matchesContainer.appendChild(createLeagueElement(name, key));
  }
})();
</script>

</body>
</html>
